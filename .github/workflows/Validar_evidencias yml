name: Validar Evidencia Subida

on:
  push:
    paths:
      - 'evidencias/**'
      - 'ids.json'

jobs:
  validar:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Leer IDs v√°lidos desde ids.json
        id: ids
        run: |
          echo "üìÑ Cargando IDs v√°lidos desde ids.json..."
          IDS_VALIDOS=$(jq -r '.ids[]' ids.json | paste -sd "|" -)
          echo "IDS_VALIDOS=$IDS_VALIDOS" >> $GITHUB_ENV

      - name: Validar ubicaci√≥n de archivos subidos
        run: |
          echo "üîç Archivos modificados en este push:"
          ARCHIVOS_CAMBIADOS=$(git diff --name-only HEAD^ HEAD)
          echo "$ARCHIVOS_CAMBIADOS"

          ERROR=0

          for ARCHIVO in $ARCHIVOS_CAMBIADOS; do
            echo "üìÅ Verificando: $ARCHIVO"
            if [[ "$ARCHIVO" =~ ^evidencias/($IDS_VALIDOS)/(entradas|salidas)/.+$ ]]; then
              echo "‚úÖ Archivo v√°lido: $ARCHIVO"
            else
              echo "‚ùå Archivo inv√°lido o fuera de ubicaci√≥n permitida: $ARCHIVO"
              ERROR=1
            fi
          done

          if [ $ERROR -eq 1 ]; then
            echo "üö´ Validaci√≥n fallida. Al menos un archivo no cumple con las reglas."
            exit 1
          else
            echo "üéâ Todos los archivos est√°n en ubicaciones v√°lidas."
          fi
